# Distributed Notification System

A scalable microservices-based notification system that sends emails and push notifications using asynchronous message queues.

## Architecture

- **API Gateway Service** (Port 8000): Entry point, authentication, routing
- **User Service** (Port 8001): User management, preferences, contact info
- **Template Service** (Port 8002): Template storage, variable substitution
- **Email Service** (Port 8003): Email processing via SMTP/SendGrid
- **Push Service** (Port 8004): Push notifications via FCM/OneSignal
- **Admin Service** (Port 8005): Admin panel, API key management

## Quick Start

### Prerequisites
- Docker & Docker Compose
- Python 3.12
- PostgreSQL 18
- RabbitMQ 3+
- Redis 6+

### Environment Setup
```bash
# Clone repository
git clone <repository-url>
cd Distributed-Notification-System

# Create environment file
cp .env.example .env
# Edit .env with your SMTP and FCM credentials
```

### Docker Deployment
```bash
# Start all services
docker-compose up -d

# Check service health
docker-compose ps

# View logs
docker-compose logs -f email_service
```

### Manual Development Setup
```bash
# Start infrastructure
docker-compose up postgres redis rabbitmq -d

# Install dependencies for each service
cd api_gateway_service && pip install -r requirements.txt
cd ../user_service && pip install -r requirements.txt
cd ../template_service && pip install -r requirements.txt
cd ../email_service && pip install -r requirements.txt
cd ../push_service && pip install -r requirements.txt
cd ../admin_service && pip install -r requirements.txt

# Run migrations
python manage.py migrate  # Run in each service directory

# Load default templates
cd template_service && python manage.py load_templates

# Start services
python manage.py runserver 8000  # API Gateway
python manage.py runserver 8001  # User Service
python manage.py runserver 8002  # Template Service
python manage.py runserver 8003  # Email Service
python manage.py runserver 8004  # Push Service
python manage.py runserver 8005  # Admin Service

# Start workers
cd email_service && python manage.py consume_emails
cd push_service && python manage.py consume_push
```

## API Usage

### 1. Register Admin & Get API Keys
```bash
POST http://localhost:8005/api/v1/register/
{
  "name": "Admin User",
  "email": "admin@example.com",
  "password": "securepassword123"
}

# Response includes API keys for all services
```

### 2. Register User
```bash
POST http://localhost:8001/api/v1/register/
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "password123",
  "preferences": {
    "email": true,
    "push": false
  }

```

### 3. Send Notification
```bash
POST http://localhost:8000/api/v1/notifications/
Headers: Authorization: Bearer <jwt_token>
{
  "notification_type": "email",
  "user_id": "uuid-here",
  "template_code": "welcome_email",
  "variables": {
    "name": "John Doe",
    "link": "https://example.com",
    "meta": {}
  },
  "request_id": "req_123456",
  "priority": 1,
  "metadata": {}
}
```

### 4. Check Notification Status
```bash
POST http://localhost:8001/api/v1/email/status/
Headers: X-API-KEY: <email_service_key>
{
  "notification_id": "email_12345678",
  "status": "delivered",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

## Configuration

### Environment Variables
```env
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/dbname

# Message Queue
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# Cache
REDIS_URL=redis://localhost:6379/0

# Email (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# Push Notifications (FCM)
FCM_SERVER_KEY=your-fcm-server-key

# API Keys (Generated by Admin Service)
API_GATEWAY_KEY=generated-key-1
USER_SERVICE_KEY=generated-key-2
TEMPLATE_SERVICE_KEY=generated-key-3
EMAIL_SERVICE_KEY=generated-key-4
PUSH_SERVICE_KEY=generated-key-5
```

## Health Checks

All services expose `/health/` endpoints:
```bash
curl http://localhost:8000/health/  # API Gateway
curl http://localhost:8001/health/  # User Service
curl http://localhost:8002/health/  # Template Service
curl http://localhost:8003/health/  # Email Service
curl http://localhost:8004/health/  # Push Service
curl http://localhost:8005/health/  # Admin Service
```

## Monitoring

### RabbitMQ Management
- URL: http://localhost:15672
- Username: guest
- Password: guest

### Queue Monitoring
```bash
# Check queue lengths
curl -u guest:guest http://localhost:15672/api/queues

# Monitor message rates
docker-compose logs -f email_worker
docker-compose logs -f push_worker
```

## CI/CD

The project includes GitHub Actions workflow:
- **Test**: Runs unit tests for all services
- **Build**: Creates Docker images
- **Deploy**: Deploys to production (configure as needed)

## Security Features

- **API Key Authentication**: Inter-service communication
- **JWT Authentication**: User authentication
- **Circuit Breaker**: Prevents cascading failures
- **Rate Limiting**: Redis-based rate limiting
- **Input Validation**: Request/response validation

## Performance

### Targets Achieved
- 1,000+ notifications per minute
- API Gateway response < 100ms
- 99.5% delivery success rate
- Horizontal scaling support

### Scaling
```bash
# Scale services
docker-compose up -d --scale email_worker=3
docker-compose up -d --scale push_worker=2
docker-compose up -d --scale api_gateway=2
```

## Troubleshooting

### Common Issues

1. **Services can't connect to database**
   ```bash
   # Check PostgreSQL is running
   docker-compose ps postgres
   
   # Check connection
   docker-compose exec postgres psql -U postgres -d notification_system
   ```

2. **RabbitMQ connection failed**
   ```bash
   # Restart RabbitMQ
   docker-compose restart rabbitmq
   
   # Check queues
   docker-compose exec rabbitmq rabbitmqctl list_queues
   ```

3. **Email sending fails**
   ```bash
   # Check SMTP credentials in .env
   # Check email service logs
   docker-compose logs email_service
   ```

### Logs
```bash
# View all service logs
docker-compose logs -f

# View specific service logs
docker-compose logs -f email_service
docker-compose logs -f push_service
```

## Testing

```bash
# Run tests for all services
./run_tests.sh

# Run tests for specific service
cd user_service && python manage.py test
```

## API Documentation

- Swagger UI: http://localhost:8000/docs/
- OpenAPI Spec: http://localhost:8000/openapi.json

## Contributing

1. Fork the repository
2. Create feature branch
3. Make changes
4. Run tests
5. Submit pull request

